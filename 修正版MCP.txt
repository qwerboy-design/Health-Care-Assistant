// MCP Client SDK 整合 - 修正版
// 參考: https://github.com/K-Dense-AI/claude-scientific-skills

import { MCPClientConfig, MCPRequest, MCPResponse } from './types';
import { getSkillsCountForWorkload } from './workload';
import { getSuggestedSkills } from './function-mapping';

/**
 * MCP Client 類別
 * 
 * 修正重點:
 * 1. 使用正確的 MCP JSON-RPC 2.0 method
 * 2. 修正請求參數格式
 * 3. Session ID 改為應用層管理(可選)
 */
export class MCPClient {
  private config: MCPClientConfig;
  private sessionId: string | null = null;

  constructor(config: MCPClientConfig) {
    this.config = config;
  }
  
  /**
   * 生成或獲取 Session ID (應用層追蹤用)
   * 注意: 這不是 MCP 協議的一部分
   */
  private getSessionId(): string {
    if (!this.sessionId) {
      this.sessionId = `session-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
    }
    return this.sessionId;
  }

  /**
   * 發送訊息到 MCP server
   */
  async sendMessage(request: MCPRequest): Promise<MCPResponse> {
    fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:entry',message:'MCP sendMessage entry',data:{hasServerUrl:!!this.config.serverUrl,serverUrl:this.config.serverUrl},timestamp:Date.now()})}).catch(()=>{});

    try {
      // 獲取建議的 Skills
      const suggestedSkills = getSuggestedSkills(request.selectedFunction);
      
      // 獲取 Skills 數量限制
      const maxSkills = getSkillsCountForWorkload(request.workloadLevel);
      
      // 應用層 session ID (可選,用於追蹤對話)
      const appSessionId = this.getSessionId();
      
      // ✅ 正確的 MCP JSON-RPC 2.0 請求格式
      const jsonRpcRequest = {
        jsonrpc: '2.0',
        id: Date.now(),
        method: 'tools/call', // ✅ 使用正確的 MCP method
        params: {
          name: 'claude-scientific-skills', // Tool 名稱
          arguments: {
            // 傳遞給 skill 的參數
            query: request.message,
            skills: suggestedSkills.slice(0, maxSkills),
            workloadLevel: request.workloadLevel,
            functionType: request.selectedFunction,
            fileUrl: request.fileUrl,
            conversationHistory: request.conversationHistory || [],
          },
        },
      };

      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:before_fetch',message:'Before fetch request',data:{method:jsonRpcRequest.method,hasParams:!!jsonRpcRequest.params,skillsCount:suggestedSkills.slice(0, maxSkills).length},timestamp:Date.now()})}).catch(()=>{});

      // 發送請求到 MCP server
      const response = await fetch(this.config.serverUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          // ✅ Session ID 只用於應用層追蹤,非 MCP 標準
          'X-App-Session-ID': appSessionId,
          ...(this.config.apiKey && { 
            'Authorization': `Bearer ${this.config.apiKey}` 
          }),
        },
        body: JSON.stringify(jsonRpcRequest),
      });

      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:after_fetch',message:'After fetch request',data:{status:response.status,ok:response.ok,contentType:response.headers.get('content-type')},timestamp:Date.now()})}).catch(()=>{});

      if (!response.ok) {
        const errorText = await response.text().catch(() => '無法讀取錯誤訊息');
        fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:error',message:'MCP Server HTTP error',data:{status:response.status,errorText:errorText.substring(0,500)},timestamp:Date.now()})}).catch(()=>{});
        
        throw new Error(`MCP Server 錯誤: ${response.status} ${response.statusText}\n${errorText}`);
      }

      const responseText = await response.text();
      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:response_received',message:'Response text received',data:{textLength:responseText.length,textPreview:responseText.substring(0,100)},timestamp:Date.now()})}).catch(()=>{});

      let jsonRpcResponse: any;
      try {
        jsonRpcResponse = JSON.parse(responseText);
      } catch (parseError: any) {
        fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:parse_error',message:'JSON parse error',data:{parseError:parseError?.message,responsePreview:responseText.substring(0,200)},timestamp:Date.now()})}).catch(()=>{});
        
        throw new Error(`MCP Server 響應格式錯誤: ${parseError?.message}`);
      }
      
      // ✅ 處理 JSON-RPC 2.0 錯誤響應
      if (jsonRpcResponse.error) {
        const errorMsg = jsonRpcResponse.error.message || JSON.stringify(jsonRpcResponse.error);
        throw new Error(`MCP Server 錯誤: ${errorMsg}`);
      }
      
      // ✅ 處理成功響應
      const result = jsonRpcResponse.result;
      if (!result) {
        throw new Error('MCP Server 未返回結果');
      }

      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:success',message:'Response parsed successfully',data:{hasResult:!!result,resultKeys:Object.keys(result)},timestamp:Date.now()})}).catch(()=>{});

      // ✅ 根據實際 MCP 響應格式調整
      return {
        content: result.content || result.output || result.text || '',
        skillsUsed: result.skillsUsed || result.tools || [],
        metadata: {
          ...result.metadata,
          sessionId: appSessionId, // 應用層 session 追蹤
        },
      };
      
    } catch (error: any) {
      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:catch',message:'MCP Client error caught',data:{errorName:error?.name,errorMessage:error?.message,errorStack:error?.stack?.substring(0,300)},timestamp:Date.now()})}).catch(()=>{});
      
      console.error('MCP Client 錯誤:', error);
      throw new Error(`無法連接到 AI 服務: ${error.message}`);
    }
  }

  /**
   * 串流式發送訊息 (Server-Sent Events)
   * 
   * 注意: 需要 MCP Server 支援 streaming
   */
  async *sendMessageStream(request: MCPRequest): AsyncGenerator<string, void, unknown> {
    const appSessionId = this.getSessionId();
    
    const jsonRpcRequest = {
      jsonrpc: '2.0',
      id: Date.now(),
      method: 'tools/call',
      params: {
        name: 'claude-scientific-skills',
        arguments: {
          query: request.message,
          stream: true, // ✅ 啟用串流
          skills: getSuggestedSkills(request.selectedFunction).slice(
            0, 
            getSkillsCountForWorkload(request.workloadLevel)
          ),
        },
      },
    };

    const response = await fetch(this.config.serverUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'text/event-stream', // ✅ SSE
        'X-App-Session-ID': appSessionId,
        ...(this.config.apiKey && { 
          'Authorization': `Bearer ${this.config.apiKey}` 
        }),
      },
      body: JSON.stringify(jsonRpcRequest),
    });

    if (!response.ok) {
      throw new Error(`MCP Server 錯誤: ${response.status}`);
    }

    // ✅ 解析 SSE stream
    const reader = response.body?.getReader();
    const decoder = new TextDecoder();

    if (!reader) {
      throw new Error('無法讀取 response stream');
    }

    try {
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = line.slice(6);
            if (data === '[DONE]') return;
            
            try {
              const parsed = JSON.parse(data);
              if (parsed.content) {
                yield parsed.content;
              }
            } catch {
              // 跳過無法解析的行
            }
          }
        }
      }
    } finally {
      reader.releaseLock();
    }
  }

  /**
   * 列出可用的 tools (MCP 標準方法)
   */
  async listTools(): Promise<any[]> {
    const jsonRpcRequest = {
      jsonrpc: '2.0',
      id: Date.now(),
      method: 'tools/list', // ✅ MCP 標準 method
      params: {},
    };

    const response = await fetch(this.config.serverUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(this.config.apiKey && { 
          'Authorization': `Bearer ${this.config.apiKey}` 
        }),
      },
      body: JSON.stringify(jsonRpcRequest),
    });

    const data = await response.json();
    return data.result?.tools || [];
  }
}

/**
 * 建立 MCP Client 實例
 */
export function createMCPClient(): MCPClient {
  const serverUrl = process.env.MCP_SERVER_URL || 
    'https://mcp.k-dense.ai/claude-scientific-skills/mcp';
  
  const apiKey = process.env.MCP_API_KEY;
  
  fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:createMCPClient',message:'createMCPClient config',data:{serverUrl,hasApiKey:!!apiKey},timestamp:Date.now()})}).catch(()=>{});

  const config: MCPClientConfig = {
    serverUrl,
    apiKey,
  };

  return new MCPClient(config);
}

/**
 * 使用範例
 */
export async function exampleUsage() {
  const client = createMCPClient();
  
  // 範例 1: 基本使用
  const response = await client.sendMessage({
    message: 'Search PubMed for recent papers on CRISPR',
    selectedFunction: 'research',
    workloadLevel: 'medium',
    conversationHistory: [],
  });
  
  console.log('Response:', response.content);
  console.log('Skills used:', response.skillsUsed);
  
  // 範例 2: 串流使用
  for await (const chunk of client.sendMessageStream({
    message: 'Analyze this RNA-seq dataset',
    selectedFunction: 'analysis',
    workloadLevel: 'high',
  })) {
    process.stdout.write(chunk);
  }
  
  // 範例 3: 列出可用 tools
  const tools = await client.listTools();
  console.log('Available tools:', tools);
}