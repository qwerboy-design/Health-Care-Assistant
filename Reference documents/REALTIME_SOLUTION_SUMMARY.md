# Realtime æ¨¡å‹åŒæ­¥è§£æ±ºæ–¹æ¡ˆç¸½çµ

> **æ›´æ–°æ—¥æœŸï¼š2026-02-04**
> æ–°å¢ LocalStorage ç‰ˆæœ¬æŒä¹…åŒ–æ©Ÿåˆ¶ï¼Œè§£æ±ºé‡æ–°ç™»å…¥å¾Œç‹€æ…‹é‚„åŸçš„å•é¡Œã€‚

## å•é¡Œæè¿°

å¾Œå°èª¿æ•´æ¨¡å‹å®šåƒ¹æˆ–ç‹€æ…‹æ™‚ï¼Œå‰å°æ¨¡å‹é¸æ“‡å™¨çŸ­æš«æ›´æ–°æˆåŠŸï¼Œä½†éš¨å¾Œåˆé‚„åŸå›èˆŠè³‡æ–™ã€‚

### å•é¡Œå ´æ™¯
1. ~~åŒä¸€æœƒè©±å…§çš„è¼ªè©¢è¦†è“‹~~ï¼ˆå·²æ–¼ v1 è§£æ±ºï¼‰
2. **é‡æ–°ç™»å…¥å¾Œç‹€æ…‹é‚„åŸ**ï¼ˆv2 æ–°è§£æ±ºï¼‰

## æ ¹æœ¬åŸå› åˆ†æ

### åŸå›  1ï¼šSupabase Read Replica Lagï¼ˆv1 å·²è§£æ±ºï¼‰

API å¯èƒ½å¾ Read Replica è®€å–å°šæœªåŒæ­¥çš„èˆŠè³‡æ–™ã€‚

### åŸå›  2ï¼šé‡æ–°ç™»å…¥æ™‚ Realtime æ›´æ–°ä¸Ÿå¤±ï¼ˆv2 è§£æ±ºï¼‰

```
æ™‚é–“ 0s:   å¾Œå°æ›´æ–° â†’ Primary DB å¯«å…¥æˆåŠŸ
æ™‚é–“ 1s:   Realtime æ”¶åˆ°è®Šæ›´ â†’ å‰ç«¯ state æ›´æ–° âœ…
æ™‚é–“ 5åˆ†é˜+: ç”¨æˆ¶é‡æ–°ç™»å…¥ï¼ˆæ–°æœƒè©±ï¼‰
           æ–°æœƒè©± fetchModels(init) â†’ API å¯èƒ½è¿”å›èˆŠæ•¸æ“š
           èˆŠæ•¸æ“šè¦†è“‹äº†ä¹‹å‰çš„ Realtime æ›´æ–° âŒ
```

**é—œéµå•é¡Œ**ï¼šRealtime æ›´æ–°åªå­˜åœ¨æ–¼ memory stateï¼Œé‡æ–°ç™»å…¥å¾Œä¸Ÿå¤±ã€‚

## è§£æ±ºæ–¹æ¡ˆ

### v2 æ¶æ§‹ï¼šLocalStorage ç‰ˆæœ¬æŒä¹…åŒ–

**æ ¸å¿ƒæ€è·¯**ï¼šå°‡ Realtime æ›´æ–°æŒä¹…åŒ–åˆ° localStorageï¼Œé‡æ–°ç™»å…¥æ™‚èˆ‡ API æ•¸æ“šé€²è¡Œç‰ˆæœ¬æ¯”è¼ƒã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœƒè©± 1                                â”‚
â”‚  Realtime æ›´æ–° â†’ æ›´æ–° state â†’ å­˜å…¥ localStorage              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼ (localStorage è·¨æœƒè©±æŒä¹…åŒ–)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœƒè©± 2ï¼ˆé‡æ–°ç™»å…¥ï¼‰                     â”‚
â”‚  fetchModels(init) â†’ API è¿”å›æ•¸æ“š                            â”‚
â”‚  æ¯”è¼ƒ localStorage ç‰ˆæœ¬ â†’ ä½¿ç”¨è¼ƒæ–°ç‰ˆæœ¬ â†’ è¨­å®š state           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯¦æ–½ç´°ç¯€

1. **æ–°å¢ç‰ˆæœ¬ç®¡ç†å·¥å…·**ï¼š`lib/storage/model-versions.ts`
   - `saveModelVersion()`: Realtime æ›´æ–°æ™‚å­˜å…¥ localStorage
   - `removeModelVersion()`: æ¨¡å‹è¢«åœç”¨/åˆªé™¤æ™‚ç§»é™¤
   - `mergeWithStoredVersions()`: åˆä½µ API æ•¸æ“šå’Œ localStorage ç‰ˆæœ¬
   - `updateStoredVersions()`: æ›´æ–° localStorage è¨˜éŒ„

2. **ä¿®æ”¹ ModelSelector.tsx**
   - Realtime äº‹ä»¶è™•ç†æ™‚èª¿ç”¨ `saveModelVersion()`
   - init fetch å¾Œèª¿ç”¨ `mergeWithStoredVersions()`
   - ç§»é™¤å±éšªçš„ else åˆ†æ”¯ï¼ˆä¸å†åœ¨æœªçŸ¥äº‹ä»¶æ™‚è§¸ç™¼ fetchï¼‰
   - å»¶é•·ä¿è­·æœŸè‡³ 10 åˆ†é˜

### ä»£ç¢¼é—œéµé‚è¼¯

```typescript
// ä¿è­·æœŸï¼š10 åˆ†é˜ï¼ˆå»¶é•·ä»¥æä¾›æ›´å¤šç·©è¡ï¼‰
const PROTECTION_PERIOD_MS = 600000;

// fetchModels ä¸­çš„ç‰ˆæœ¬åˆä½µ
if (source === 'init') {
  fetchedModels = mergeWithStoredVersions(fetchedModels);
  console.log('[ModelSelector] Merged with localStorage versions');
}

// Realtime äº‹ä»¶è™•ç†ä¸­çš„æŒä¹…åŒ–
if (eventType.toUpperCase() === 'UPDATE' && newRow) {
  // ... æ›´æ–° state ...
  saveModelVersion(updated); // é—œéµï¼šæŒä¹…åŒ–åˆ° localStorage
}
```

### ç‰ˆæœ¬æ¯”è¼ƒé‚è¼¯

```typescript
// mergeWithStoredVersions() æ ¸å¿ƒé‚è¼¯
const comparison = compareTimestamps(storedVersion.updated_at, apiModel.updated_at);

if (comparison > 0) {
  // localStorage ç‰ˆæœ¬è¼ƒæ–°ï¼Œä½¿ç”¨å„²å­˜çš„æ•¸æ“š
  return storedVersion.data;
}

// API ç‰ˆæœ¬è¼ƒæ–°æˆ–ç›¸åŒï¼Œä½¿ç”¨ API æ•¸æ“š
return apiModel;
```

## å„ªé»

### 1. å³æ™‚æ€§
- Realtime å»¶é² < 1 ç§’
- ç„¡éœ€ç­‰å¾…è¼ªè©¢é€±æœŸ

### 2. è·¨æœƒè©±ä¸€è‡´æ€§ï¼ˆv2 æ–°å¢ï¼‰
- é‡æ–°ç™»å…¥å¾Œä»èƒ½ç²å–æœ€æ–°æ•¸æ“š
- localStorage ä½œç‚ºç‰ˆæœ¬æ¯”è¼ƒåŸºæº–

### 3. å¯é æ€§
- Realtime ä½œç‚ºä¸»è¦æ©Ÿåˆ¶
- localStorage ä½œç‚ºè·¨æœƒè©±æ©‹æ¨‘
- 10 åˆ†é˜é•·è¼ªè©¢ä½œç‚ºæœ€å¾Œå‚™æ´

### 4. é¿å…è¡çª
- ç‰ˆæœ¬æ¯”è¼ƒç¢ºä¿åªä½¿ç”¨è¼ƒæ–°çš„æ•¸æ“š
- ä¸æœƒè¢«ä»»ä½•ä¾†æºçš„èˆŠè³‡æ–™è¦†è“‹

## æ¸¬è©¦è¨ˆç•«

âœ… **æˆåŠŸæ¡ˆä¾‹**
- å¾Œå°æ›´æ–°æ¨¡å‹å®šåƒ¹ â†’ å‰ç«¯ < 1 ç§’æ›´æ–°
- åˆ‡æ›åˆ†é  â†’ ä¸æœƒè§¸ç™¼ä¸å¿…è¦çš„ API fetch
- ç­‰å¾… 10 åˆ†é˜+ â†’ å‰ç«¯æŒçºŒä¿æŒæ­£ç¢ºçš„æ›´æ–°è³‡æ–™
- **é‡æ–°ç™»å…¥ â†’ å‰ç«¯é¡¯ç¤ºæœ€æ–°æ•¸æ“š**ï¼ˆv2 æ–°å¢ï¼‰

âŒ **ä¿®å¾©å‰çš„å¤±æ•—æ¡ˆä¾‹**
- Realtime æ›´æ–°æˆåŠŸ â†’ é‡æ–°ç™»å…¥ â†’ é¡¯ç¤ºèˆŠè³‡æ–™

## ç›¸é—œæ–‡ä»¶

- `lib/storage/model-versions.ts` - localStorage ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼ˆv2 æ–°å¢ï¼‰
- `components/chat/ModelSelector.tsx` - å‰ç«¯ Realtime è¨‚é–±é‚è¼¯
- `supabase/migrations/005_add_realtime_publication.sql` - Realtime publication è¨­å®š
- `app/test-realtime/page.tsx` - Realtime é€£ç·šæ¸¬è©¦é é¢

## ç›£æ§èˆ‡é™¤éŒ¯

### æ¸¬è©¦é é¢
http://localhost:3000/test-realtime

### Console é—œéµ Log
- `ğŸ¯ Realtime event received` - æ”¶åˆ° Realtime äº‹ä»¶
- `â™»ï¸ UPDATE: model_name` - Realtime æ›´æ–°è™•ç†
- `ğŸ’¾ Saved version for model_name` - æŒä¹…åŒ–åˆ° localStorage
- `ğŸ”„ Using localStorage version for model_name` - ä½¿ç”¨ localStorage ç‰ˆæœ¬
- `âœ… Merged X model(s) from localStorage` - ç‰ˆæœ¬åˆä½µå®Œæˆ
- `â­ï¸ Skip fetchModels` - ä¿è­·æ©Ÿåˆ¶é‹ä½œä¸­

### localStorage èª¿è©¦

åœ¨ç€è¦½å™¨ DevTools Console ä¸­ï¼š
```javascript
// æŸ¥çœ‹å„²å­˜çš„ç‰ˆæœ¬æ•¸æ“š
JSON.parse(localStorage.getItem('hac-model-versions'))

// æ¸…é™¤ç‰ˆæœ¬æ•¸æ“šï¼ˆæ¸¬è©¦ç”¨ï¼‰
localStorage.removeItem('hac-model-versions')
```

### å¸¸è¦‹å•é¡Œ

**Q: å¦‚æœ Realtime é€£ç·šå¤±æ•—æ€éº¼è¾¦ï¼Ÿ**
A: 10 åˆ†é˜é•·è¼ªè©¢æœƒä½œç‚ºå‚™æ´ï¼Œç¢ºä¿æœ€çµ‚ä¸€è‡´æ€§ã€‚

**Q: localStorage æ•¸æ“šæœƒéæœŸå—ï¼Ÿ**
A: æ˜¯çš„ï¼Œè¶…é 24 å°æ™‚çš„ç‰ˆæœ¬è¨˜éŒ„æœƒè‡ªå‹•æ¸…ç†ã€‚

**Q: å¦‚æœç”¨æˆ¶æ¸…é™¤ç€è¦½å™¨æ•¸æ“šæ€éº¼è¾¦ï¼Ÿ**
A: æœƒå›é€€åˆ° API æ•¸æ“šï¼Œé€™æ˜¯æ­£å¸¸è¡Œç‚ºã€‚Realtime æ›´æ–°å¾Œæœƒé‡æ–°å»ºç«‹ localStorage è¨˜éŒ„ã€‚

**Q: 10 åˆ†é˜ä¿è­·æœŸæœƒä¸æœƒå¤ªé•·ï¼Ÿ**
A: æ­£å¸¸æƒ…æ³ä¸‹å®Œå…¨ä¾è³´ Realtime + localStorage ç‰ˆæœ¬æ¯”è¼ƒï¼Œè¼ªè©¢å¾ˆå°‘åŸ·è¡Œã€‚10 åˆ†é˜åªæ˜¯é¡å¤–ä¿éšœã€‚

## ç‰ˆæœ¬æ­·å²

### v2ï¼ˆ2026-02-04ï¼‰
- æ–°å¢ LocalStorage ç‰ˆæœ¬æŒä¹…åŒ–æ©Ÿåˆ¶
- è§£æ±ºé‡æ–°ç™»å…¥å¾Œç‹€æ…‹é‚„åŸçš„å•é¡Œ
- å»¶é•·ä¿è­·æœŸè‡³ 10 åˆ†é˜
- ç§»é™¤å±éšªçš„ else åˆ†æ”¯

### v1ï¼ˆåˆå§‹ç‰ˆæœ¬ï¼‰
- å¯¦ç¾ Realtime è¨‚é–±
- 5 åˆ†é˜ä¿è­·æœŸæ©Ÿåˆ¶
- ç§»é™¤çŸ­é–“éš”è¼ªè©¢

## çµè«–

é€šé LocalStorage ç‰ˆæœ¬æŒä¹…åŒ–æ©Ÿåˆ¶ï¼ŒæˆåŠŸè§£æ±ºäº†é‡æ–°ç™»å…¥å¾Œæ¨¡å‹ç‹€æ…‹é‚„åŸçš„å•é¡Œã€‚ç³»çµ±ç¾åœ¨å…·å‚™ï¼š

- âœ… å³æ™‚æ›´æ–°ï¼ˆ< 1 ç§’ï¼‰
- âœ… è·¨æœƒè©±ä¸€è‡´æ€§ï¼ˆlocalStorage ç‰ˆæœ¬æ¯”è¼ƒï¼‰
- âœ… é«˜å¯é æ€§ï¼ˆRealtime + localStorage + é•·è¼ªè©¢å‚™æ´ï¼‰
- âœ… ä½è³‡æºæ¶ˆè€—ï¼ˆæ¸›å°‘ä¸å¿…è¦çš„ API è«‹æ±‚ï¼‰
- âœ… ç„¡ç‹€æ…‹è¡çªï¼ˆç‰ˆæœ¬æ¯”è¼ƒç¢ºä¿ä½¿ç”¨æœ€æ–°æ•¸æ“šï¼‰
