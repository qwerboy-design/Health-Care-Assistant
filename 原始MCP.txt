// MCP Client SDK 整合
// 參考: https://github.com/K-Dense-AI/claude-scientific-skills

import { MCPClientConfig, MCPRequest, MCPResponse } from './types';
import { getSkillsCountForWorkload } from './workload';
import { getSuggestedSkills } from './function-mapping';

/**
 * MCP Client 類別
 * 
 * 注意：這是一個簡化的實作範例
 * 實際使用時需要根據 MCP SDK 的具體 API 調整
 */
export class MCPClient {
  private config: MCPClientConfig;
  private sessionId: string | null = null;

  constructor(config: MCPClientConfig) {
    this.config = config;
  }
  
  /**
   * 生成或獲取 MCP Session ID
   */
  private getSessionId(): string {
    if (!this.sessionId) {
      // 生成一個新的 session ID（使用 UUID 格式）
      this.sessionId = `mcp-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
    }
    return this.sessionId;
  }

  /**
   * 發送訊息到 MCP server
   */
  async sendMessage(request: MCPRequest): Promise<MCPResponse> {
    // #region agent log
    fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:24',message:'MCP sendMessage entry',data:{hasServerUrl:!!this.config.serverUrl,serverUrl:this.config.serverUrl,hasApiKey:!!this.config.apiKey},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    try {
      // 獲取建議的 Skills
      const suggestedSkills = getSuggestedSkills(request.selectedFunction);
      
      // 獲取 Skills 數量限制
      const maxSkills = getSkillsCountForWorkload(request.workloadLevel);
      
      // 生成或獲取 session ID
      const sessionId = this.getSessionId();
      
      // 構建 MCP 請求參數
      const params = {
        sessionId: sessionId,
        message: request.message,
        skills: suggestedSkills.slice(0, maxSkills),
        context: {
          workloadLevel: request.workloadLevel,
          functionType: request.selectedFunction,
          fileUrl: request.fileUrl,
        },
        conversationHistory: request.conversationHistory || [],
      };
      
      // 構建 JSON-RPC 2.0 格式的請求
      const jsonRpcRequest = {
        jsonrpc: '2.0',
        id: Date.now(),
        method: 'completion/complete', // 嘗試使用標準 MCP completion method
        params: params,
      };
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:42',message:'Before fetch request',data:{method:jsonRpcRequest.method,hasParams:!!jsonRpcRequest.params,sessionId:sessionId,skillsCount:suggestedSkills.slice(0, maxSkills).length,hasMessage:!!params.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
      // #endregion

      // 發送請求到 MCP server
      // 注意：這裡需要根據實際的 MCP SDK API 調整
      const response = await fetch(this.config.serverUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json, text/event-stream',
          'X-Session-ID': sessionId,
          ...(this.config.apiKey && { 'Authorization': `Bearer ${this.config.apiKey}` }),
        },
        body: JSON.stringify(jsonRpcRequest),
      });
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:54',message:'After fetch request',data:{status:response.status,statusText:response.statusText,ok:response.ok,contentType:response.headers.get('content-type')},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
      // #endregion

      if (!response.ok) {
        // #region agent log
        const errorText = await response.text().catch(() => '無法讀取錯誤訊息');
        fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:57',message:'MCP Server HTTP error',data:{status:response.status,statusText:response.statusText,errorText:errorText.substring(0,500)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
        throw new Error(`MCP Server 錯誤: ${response.status} ${response.statusText}`);
      }

      const responseText = await response.text();
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:81',message:'Response text received',data:{textLength:responseText.length,textPreview:responseText.substring(0,100)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
      // #endregion
      let jsonRpcResponse: any;
      try {
        jsonRpcResponse = JSON.parse(responseText);
      } catch (parseError: any) {
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:87',message:'JSON parse error',data:{parseError:parseError?.message,responsePreview:responseText.substring(0,200)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
        // #endregion
        throw new Error(`MCP Server 響應格式錯誤: ${parseError?.message}`);
      }
      
      // 處理 JSON-RPC 2.0 響應
      if (jsonRpcResponse.error) {
        throw new Error(`MCP Server 錯誤: ${jsonRpcResponse.error.message || JSON.stringify(jsonRpcResponse.error)}`);
      }
      
      const data = jsonRpcResponse.result || jsonRpcResponse;
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:95',message:'Response parsed successfully',data:{hasResult:!!jsonRpcResponse.result,hasContent:!!data.content,hasMessage:!!data.message,hasSkillsUsed:!!data.skillsUsed},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
      // #endregion

      return {
        content: data.content || data.message || data.text || '',
        skillsUsed: data.skillsUsed || data.skills || [],
        metadata: data.metadata || {},
      };
    } catch (error: any) {
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:sendMessage:68',message:'MCP Client error caught',data:{errorName:error?.name,errorMessage:error?.message,errorStack:error?.stack?.substring(0,300)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
      // #endregion
      console.error('MCP Client 錯誤:', error);
      throw new Error('無法連接到 AI 服務，請稍後再試');
    }
  }

  /**
   * 串流式發送訊息（用於 SSE）
   */
  async *sendMessageStream(request: MCPRequest): AsyncGenerator<string, void, unknown> {
    // 這裡應該實作 SSE 串流
    // 簡化版本先回傳完整回應
    const response = await this.sendMessage(request);
    yield response.content;
  }
}

/**
 * 建立 MCP Client 實例
 */
export function createMCPClient(): MCPClient {
  // 從環境變數讀取，預設值為官方 MCP Server URL
  const serverUrl = process.env.MCP_SERVER_URL || 'https://mcp.k-dense.ai/claude-scientific-skills/mcp';
  
  // API Key 為可選，如果不設定則不使用認證（預設使用 MCP Server，無需 API Key）
  const apiKey = process.env.MCP_API_KEY;
  // #region agent log
  fetch('http://127.0.0.1:7245/ingest/6d2429d6-80c8-40d7-a840-5b2ce679569d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'lib/mcp/client.ts:createMCPClient:86',message:'createMCPClient config',data:{serverUrl,hasApiKey:!!apiKey},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
  // #endregion

  const config: MCPClientConfig = {
    serverUrl,
    apiKey,
  };

  return new MCPClient(config);
}
