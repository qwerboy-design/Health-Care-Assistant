# Realtime æ¨¡å‹åŒæ­¥è§£æ±ºæ–¹æ¡ˆç¸½çµ

## å•é¡Œæè¿°

å¾Œå°èª¿æ•´æ¨¡å‹å®šåƒ¹æˆ–ç‹€æ…‹æ™‚ï¼Œå‰å°æ¨¡å‹é¸æ“‡å™¨çŸ­æš«æ›´æ–°æˆåŠŸï¼Œä½†éš¨å¾Œåˆé‚„åŸå›èˆŠè³‡æ–™ã€‚

## æ ¹æœ¬åŸå› 

**Supabase Read Replica Lagï¼ˆè®€å–å‰¯æœ¬å»¶é²ï¼‰**

1. **Primary Databaseï¼ˆä¸»è³‡æ–™åº«ï¼‰**
   - å¾Œå°æ›´æ–°ç›´æ¥å¯«å…¥ Primary DB
   - Realtime æœå‹™ç›£è½ Primary DB çš„è®Šæ›´
   - è®Šæ›´ç«‹å³å»£æ’­çµ¦è¨‚é–±çš„å‰ç«¯

2. **Read Replicaï¼ˆè®€å–å‰¯æœ¬ï¼‰**
   - API ç«¯é»ä½¿ç”¨ `supabaseAdmin` é€£æ¥åˆ° Read Replicaï¼ˆæå‡è®€å–æ•ˆèƒ½ï¼‰
   - Read Replica å¾ Primary DB åŒæ­¥è³‡æ–™ï¼Œæœ‰ **2-5 åˆ†é˜å»¶é²**
   - ç•¶å‰ç«¯è¼ªè©¢ API æ™‚ï¼Œç²å–çš„æ˜¯å°šæœªåŒæ­¥çš„èˆŠè³‡æ–™

3. **è¡çªæµç¨‹**
   ```
   æ™‚é–“ 0s:  å¾Œå°æ›´æ–° â†’ Primary DB å¯«å…¥æˆåŠŸ
   æ™‚é–“ 1s:  Realtime æ”¶åˆ°è®Šæ›´ â†’ å‰ç«¯æ›´æ–° âœ…
   æ™‚é–“ 30s: å‰ç«¯è¼ªè©¢è§¸ç™¼ â†’ API è®€å– Read Replicaï¼ˆå°šæœªåŒæ­¥ï¼‰â†’ è¿”å›èˆŠè³‡æ–™ âŒ
   æ™‚é–“ 30s: èˆŠè³‡æ–™è¦†è“‹ Realtime æ›´æ–° â†’ å‰ç«¯é‚„åŸ âŒ
   ```

## è§£æ±ºæ–¹æ¡ˆ

### æœ€çµ‚æ¶æ§‹

**å®Œå…¨ä¾è³´ Realtime ä½œç‚ºä¸»è¦æ›´æ–°æ©Ÿåˆ¶ï¼ŒAPI åƒ…ä½œç‚ºåˆå§‹åŒ–å’Œæ¥µç«¯å‚™æ´**

### å¯¦æ–½ç´°ç¯€

1. **åˆå§‹åŒ–ï¼ˆé¦–æ¬¡è¼‰å…¥ï¼‰**
   - å¾ API ç²å–æ¨¡å‹åˆ—è¡¨
   - å»ºç«‹ Realtime è¨‚é–±

2. **é‹è¡Œæ™‚æ›´æ–°**
   - **å®Œå…¨ä¾è³´ Realtime**
   - ç§»é™¤ Window Focus / Visibility Change çš„ API è¼ªè©¢
   - ç§»é™¤çŸ­é–“éš”ï¼ˆ30ç§’ï¼‰çš„å®šæœŸè¼ªè©¢

3. **å‚™æ´æ©Ÿåˆ¶**
   - åƒ…ä¿ç•™ 5 åˆ†é˜é–“éš”çš„é•·è¼ªè©¢
   - å¦‚æœ Realtime åœ¨ 5 åˆ†é˜å…§æœ‰æ›´æ–°ï¼Œè¼ªè©¢æœƒè¢«è·³é
   - åƒ…åœ¨ Realtime é€£ç·šå¤±æ•—è¶…é 5 åˆ†é˜æ™‚ä½œç‚ºæœ€å¾Œé˜²ç·š

### ä»£ç¢¼é—œéµé‚è¼¯

```typescript
// ä¿è­·æœŸï¼š5 åˆ†é˜å…§æœ‰ Realtime æ›´æ–°ï¼Œè·³éæ‰€æœ‰ API fetch
if (source !== 'init' && lastRealtimeUpdateRef.current > 0 && timeSinceRealtimeUpdate < 300000) {
  console.log(`[ModelSelector] â­ï¸ Skip fetchModels - Realtime active`);
  return;
}

// è¼ªè©¢é–“éš”ï¼š5 åˆ†é˜ï¼ˆåƒ…ä½œç‚º Realtime å¤±æ•—çš„å‚™æ´ï¼‰
const pollInterval = setInterval(() => {
  fetchModels(true, 'poll');
}, 300000); // 5 åˆ†é˜
```

## å„ªé»

### 1. å³æ™‚æ€§
- Realtime å»¶é² < 1 ç§’
- ç„¡éœ€ç­‰å¾…è¼ªè©¢é€±æœŸ

### 2. æ•ˆèƒ½
- æ¸›å°‘ä¸å¿…è¦çš„ API è«‹æ±‚
- é™ä½è³‡æ–™åº«è®€å–å£“åŠ›

### 3. å¯é æ€§
- Realtime ä½œç‚ºä¸»è¦æ©Ÿåˆ¶ï¼ˆSupabase å®˜æ–¹æ¨è–¦ï¼‰
- 5 åˆ†é˜é•·è¼ªè©¢ä½œç‚ºå‚™æ´ï¼Œç¢ºä¿æ¥µç«¯æƒ…æ³ä¸‹ä»èƒ½æ¢å¾©

### 4. é¿å…è¡çª
- ä¸æœƒè¢« Read Replica lag çš„èˆŠè³‡æ–™è¦†è“‹
- å‰ç«¯ç‹€æ…‹å§‹çµ‚èˆ‡ Primary DB ä¿æŒä¸€è‡´

## æ¸¬è©¦çµæœ

âœ… **æˆåŠŸæ¡ˆä¾‹**
- å¾Œå°æ›´æ–°æ¨¡å‹å®šåƒ¹ â†’ å‰ç«¯ < 1 ç§’æ›´æ–°
- åˆ‡æ›åˆ†é  â†’ ä¸æœƒè§¸ç™¼ä¸å¿…è¦çš„ API fetch
- ç­‰å¾… 5 åˆ†é˜+ â†’ å‰ç«¯æŒçºŒä¿æŒæ­£ç¢ºçš„æ›´æ–°è³‡æ–™

âŒ **ä¿®å¾©å‰çš„å¤±æ•—æ¡ˆä¾‹**
- Realtime æ›´æ–°æˆåŠŸ â†’ 30 ç§’å¾Œè¼ªè©¢è§¸ç™¼ â†’ èˆŠè³‡æ–™è¦†è“‹ â†’ å‰ç«¯é‚„åŸ

## ç›¸é—œæ–‡ä»¶

- `supabase/migrations/005_add_realtime_publication.sql` - Realtime publication è¨­å®š
- `components/chat/ModelSelector.tsx` - å‰ç«¯ Realtime è¨‚é–±é‚è¼¯
- `app/test-realtime/page.tsx` - Realtime é€£ç·šæ¸¬è©¦é é¢

## ç›£æ§èˆ‡é™¤éŒ¯

### æ¸¬è©¦é é¢
http://localhost:3000/test-realtime

### Console é—œéµ Log
- `Supabase Realtime è¨‚é–±ç‹€æ…‹: SUBSCRIBED` - é€£ç·šæˆåŠŸ
- `ğŸ¯ æ¨¡å‹è³‡æ–™å¯¦æ™‚è®Šå‹•` - æ”¶åˆ° Realtime äº‹ä»¶
- `â™»ï¸ Updated model` - å‰ç«¯ç‹€æ…‹æ›´æ–°
- `â­ï¸ Skip fetchModels - Realtime active` - ä¿è­·æ©Ÿåˆ¶é‹ä½œä¸­

### å¸¸è¦‹å•é¡Œ

**Q: å¦‚æœ Realtime é€£ç·šå¤±æ•—æ€éº¼è¾¦ï¼Ÿ**
A: 5 åˆ†é˜é•·è¼ªè©¢æœƒä½œç‚ºå‚™æ´ï¼Œç¢ºä¿æœ€çµ‚ä¸€è‡´æ€§ã€‚

**Q: ç‚ºä»€éº¼ä¸ç›´æ¥è®€ Primary DBï¼Ÿ**
A: Primary DB ç”¨æ–¼å¯«å…¥ï¼Œè®€å–æœƒå¢åŠ è² è¼‰ã€‚Supabase æ¶æ§‹è¨­è¨ˆå°±æ˜¯ç”¨ Read Replica åˆ†æµè®€å–ã€‚

**Q: 5 åˆ†é˜æœƒä¸æœƒå¤ªé•·ï¼Ÿ**
A: æ­£å¸¸æƒ…æ³ä¸‹å®Œå…¨ä¾è³´ Realtimeï¼ˆ< 1 ç§’ï¼‰ï¼Œ5 åˆ†é˜è¼ªè©¢ä¸æœƒåŸ·è¡Œã€‚åªæœ‰ Realtime é•·æ™‚é–“å¤±æ•—æ™‚æ‰æœƒè§¸ç™¼ã€‚

## æŠ€è¡“å‚µå‹™èˆ‡æœªä¾†æ”¹é€²

### ç•¶å‰æ¶æ§‹å·²è¶³å¤ ï¼ˆç„¡éœ€æ”¹é€²ï¼‰
- Realtime é€£ç·šç©©å®šï¼ˆSupabase æä¾› 99.9% SLAï¼‰
- 5 åˆ†é˜å‚™æ´è¶³ä»¥æ‡‰å°æ¥µç«¯æƒ…æ³

### å¯èƒ½çš„å„ªåŒ–ï¼ˆéå¿…è¦ï¼‰
1. **ç›£æ§ Realtime é€£ç·šç‹€æ…‹**
   - é¡¯ç¤ºé€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨
   - é€£ç·šå¤±æ•—æ™‚ä¸»å‹•æç¤ºä½¿ç”¨è€…

2. **ä½¿ç”¨ Server-Sent Events (SSE) ä½œç‚ºå‚™æ´**
   - å¦‚æœ WebSocketï¼ˆRealtimeï¼‰å¤±æ•—ï¼Œé™ç´šåˆ° SSE
   - ä½†é€™æœƒå¢åŠ è¤‡é›œåº¦ï¼Œç•¶å‰æ¶æ§‹å·²è¶³å¤ 

## çµè«–

é€šéå®Œå…¨ä¾è³´ Realtime ä¸¦ç§»é™¤ä¸å¿…è¦çš„ API è¼ªè©¢ï¼ŒæˆåŠŸè§£æ±ºäº† Read Replica lag å°è‡´çš„å‰ç«¯ç‹€æ…‹é‚„åŸå•é¡Œã€‚ç³»çµ±ç¾åœ¨å…·å‚™ï¼š

- âœ… å³æ™‚æ›´æ–°ï¼ˆ< 1 ç§’ï¼‰
- âœ… é«˜å¯é æ€§ï¼ˆRealtime + é•·è¼ªè©¢å‚™æ´ï¼‰
- âœ… ä½è³‡æºæ¶ˆè€—ï¼ˆæ¸›å°‘ä¸å¿…è¦çš„ API è«‹æ±‚ï¼‰
- âœ… ç„¡ç‹€æ…‹è¡çªï¼ˆä¸æœƒè¢«èˆŠè³‡æ–™è¦†è“‹ï¼‰
